<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Instagram Non‑Followers Checker</title>
    <!-- Bootstrap for quick responsive styling -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-YJHkCpUe1XqGv2y6E5K0Vrcm1WVNHfW45fB77F4fhGHaB9YvWgeYkKrrnKmRXS4V"
      crossorigin="anonymous"
    />
    <!-- JSZip for client‑side ZIP parsing -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <style>
      body {
        padding: 1rem;
      }
      #result ul {
        max-height: 60vh;
        overflow-y: auto;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container-sm">
      <h1 class="mb-4 text-center fs-3">Instagram Non‑Followers Checker</h1>

      <div class="card shadow-sm p-3 mb-4">
        <label for="zipInput" class="form-label fw-semibold"
          >1. Upload your <code>.zip</code> export</label
        >
        <input type="file" id="zipInput" accept=".zip" class="form-control" />
        <div class="form-text">
          Expected structure:
          <code>connections/followers_and_following/</code> containing
          <code>followers_*.json</code> + <code>following.json</code>.
        </div>
      </div>

      <div id="result" class="card shadow-sm d-none p-3"></div>
    </div>

    <script>
      const zipInput = document.getElementById("zipInput");
      const resultCard = document.getElementById("result");

      zipInput.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
          // Read ZIP as ArrayBuffer then load via JSZip
          const arrayBuffer = await file.arrayBuffer();
          const zip = await JSZip.loadAsync(arrayBuffer);

          // Collect followers & following JSON entries
          const followerEntries = [];
          const followingEntries = [];

          zip.forEach((relativePath, zipEntry) => {
            if (
              /connections\/(followers_and_following|followers_and_following\/)\/followers.*\.json$/i.test(
                relativePath
              )
            ) {
              followerEntries.push(zipEntry);
            } else if (
              /connections\/(followers_and_following|followers_and_following\/)\/following\.json$/i.test(
                relativePath
              )
            ) {
              followingEntries.push(zipEntry);
            }
          });

          if (followerEntries.length === 0 || followingEntries.length === 0) {
            alert("Could not find the required files inside the ZIP.");
            return;
          }

          // Parse followers list (may be split across multiple files)
          const followersSet = new Set();
          for (const entry of followerEntries) {
            const text = await entry.async("string");
            const data = JSON.parse(text);
            data.forEach((item) => {
              const username = item.string_list_data?.[0]?.value;
              if (username) followersSet.add(username.toLowerCase());
            });
          }

          // Parse following list (single JSON with relationships_following array)
          const followingSet = new Set();
          for (const entry of followingEntries) {
            const text = await entry.async("string");
            const data = JSON.parse(text);
            (data.relationships_following || []).forEach((item) => {
              const username = item.string_list_data?.[0]?.value;
              if (username) followingSet.add(username.toLowerCase());
            });
          }

          // Accounts you follow that don't follow you back
          const notFollowingBack = [...followingSet].filter(
            (u) => !followersSet.has(u)
          );

          // Build result HTML
          resultCard.innerHTML = `
          <h5 class="fw-semibold">Accounts not following you back <span class="badge bg-primary">${
            notFollowingBack.length
          }</span></h5>
          <ul class="list-group list-group-flush mt-2">${notFollowingBack
            .map((u) => `<li class="list-group-item">${u}</li>`)
            .join("")}</ul>
        `;
          resultCard.classList.remove("d-none");
        } catch (err) {
          console.error(err);
          alert(
            "Something went wrong while processing the ZIP. Please make sure you selected the correct file."
          );
        }
      });
    </script>
  </body>
</html>
